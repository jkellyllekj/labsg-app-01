GOAL
Add structured intensity metadata to the JSON response from the workout generator endpoint, without changing any UI code or CSS.
Backwards compatible. Keep workoutText exactly as is.

FILE TO EDIT
index.js

EDIT RULE
Do not invent logic. Do not refactor. Do not move code around.
Only do the mechanical insertion and replacement exactly as written below.

STEP 1
Open index.js.

STEP 2
Find the Express route handler for the generator endpoint.
Search for this exact string first:
app.post("/generate-workout"

If that exact string is not present, then search for:
generate-workout
and then for:
workoutText

Stop when you are inside the handler that builds workoutText and returns JSON for a successful generation.

STEP 3
Inside that handler, find the success response that returns workoutText.
It will look like one of these patterns:

return res.json({ ok: true, workoutText });

or

res.json({ ok: true, workoutText });

or

return res.status(200).json({ ok: true, workoutText });

STEP 4
Immediately before that success response, insert the helper functions and metadata computation block below.

STEP 5
Replace the success response so it returns these additional fields:
sections, sectionMeta, workoutMeta

Do not remove workoutText.
Do not rename workoutText.

INSERT THIS BLOCK (paste exactly, inside the same handler, right before the success response)

const parsed = parseWorkoutTextToSections(workoutText);

const sectionMeta = parsed.sections.map((s) => {
  const zone = inferZoneFromText(s.body);
  const isStriated = inferIsStriatedFromText(s.body);
  return { zone, isStriated };
});

const workoutMeta = (() => {
  const zones = sectionMeta.map((m) => m.zone);
  const hasRed = zones.includes("full_gas");
  const redSectionsCount = zones.filter((z) => z === "full_gas").length;
  return { hasRed, redSectionsCount };
})();

function parseWorkoutTextToSections(text) {
  const raw = String(text || "");
  const lines = raw.split("\n");

  const sections = [];
  let current = null;

  const flush = () => {
    if (!current) return;
    current.body = current.bodyLines.join("\n").trim();
    delete current.bodyLines;
    sections.push(current);
    current = null;
  };

  // Heuristic: section headers are lines ending with ":" like "Warm up:" or "Main:"
  // Distance may appear on the same line like "Main: 800" or in brackets, but we keep dist best-effort only.
  const headerRe = /^([A-Za-z][A-Za-z0-9 \-]*?)\s*:\s*(.*)$/;

  for (const line of lines) {
    const m = line.match(headerRe);
    if (m) {
      flush();
      const label = String(m[1] || "").trim();
      const tail = String(m[2] || "").trim();

      // Best-effort distance extraction from the header tail
      let dist = null;
      const distMatch = tail.match(/(^|\s)(\d{2,5})(\s|$)/);
      if (distMatch) dist = Number(distMatch[2]);

      current = { label, dist, bodyLines: [] };
      if (tail) current.bodyLines.push(tail);
      continue;
    }

    if (!current) {
      // Ignore leading junk until first header
      continue;
    }

    current.bodyLines.push(line);
  }

  flush();

  // If we failed to find headers, fall back to a single section
  if (!sections.length && raw.trim()) {
    return {
      sections: [
        { label: "Workout", dist: null, body: raw.trim() }
      ]
    };
  }

  return { sections };
}

function inferZoneFromText(body) {
  const t = String(body || "").toLowerCase();

  if (t.includes("full gas") || t.includes("fullgas") || t.includes("all out") || t.includes("max effort") || t.includes("sprint")) {
    return "full_gas";
  }

  if (t.includes("threshold") || t.includes("race pace") || t.includes("hard")) {
    return "hard";
  }

  if (t.includes("strong") || t.includes("fast")) {
    return "strong";
  }

  if (t.includes("moderate") || t.includes("steady")) {
    return "moderate";
  }

  return "easy";
}

function inferIsStriatedFromText(body) {
  const t = String(body || "").toLowerCase();

  // Coach style striation cues
  if (t.includes("odds") && t.includes("evens")) return true;
  if (t.includes("descend")) return true;
  if (t.includes("build")) return true;
  if (t.includes("negative split")) return true;
  if (t.match(/\b(\d+)\s*to\s*(\d+)\b/)) return true;

  return false;
}

STEP 6
Now replace the existing success response line(s) that return workoutText with this exact response:

return res.json({
  ok: true,
  workoutText,
  sections: parsed.sections,
  sectionMeta,
  workoutMeta
});

IMPORTANT
Keep this inside the same successful try path as the old response.
Do not change error handling.
Do not change any other endpoints.
Do not change any UI code, HTML strings, or CSS.

STEP 7
Run whatever minimal existing local test exists for generation.
If there is no test script, do a single manual request using the app itself and confirm the network response JSON now includes:
sections
sectionMeta
workoutMeta

Then stop.

COMMIT MESSAGE
feat(api): include sections and intensity metadata in generate response
